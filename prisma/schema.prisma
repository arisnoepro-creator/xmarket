datasource db { provider = "postgresql"; url = env("DATABASE_URL") }
generator client { provider = "prisma-client-js" }

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  name            String?
  image           String?
  role            Role     @default(USER)
  stripeAccountId String?
  verifiedSeller  Boolean  @default(false)
  shopSlug        String?  @unique
  shopBio         String?
  shopBanner      String?

  listings        Listing[]
  orders          Order[]  @relation("BuyerOrders")
  favorites       Favorite[]
  reviewsAbout    Review[] @relation("AboutReviews")
  reviewsWritten  Review[] @relation("WrittenReviews")

  rating          Float    @default(0)
  createdAt       DateTime @default(now())
}

model Listing {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String
  priceCents  Int
  currency    String   @default("EUR")
  condition   Condition
  brand       String?
  size        String?
  category    String

  photos      Photo[]
  seller      User     @relation(fields: [sellerId], references: [id])
  sellerId    String
  status      ListingStatus @default(ACTIVE)
  createdAt   DateTime @default(now())

  offers      Offer[]
  favorites   Favorite[]
  order       Order?

  @@index([category])
  @@index([brand])
  @@index([size])
  @@index([condition])
  @@index([priceCents])
  @@index([createdAt])
}

model Photo {
  id        String  @id @default(cuid())
  url       String
  order     Int     @default(0)
  listing   Listing @relation(fields: [listingId], references: [id])
  listingId String
}

model Offer {
  id          String   @id @default(cuid())
  listingId   String
  listing     Listing  @relation(fields: [listingId], references: [id])
  buyerId     String
  amountCents Int
  status      OfferStatus @default(PENDING)
  createdAt   DateTime @default(now())

  @@index([listingId, buyerId])
}

model Favorite {
  userId    String
  listingId String

  user      User    @relation(fields: [userId], references: [id])
  listing   Listing @relation(fields: [listingId], references: [id])

  @@id([userId, listingId])
}

model Order {
  id           String   @id @default(cuid())
  buyerId      String
  buyer        User     @relation("BuyerOrders", fields: [buyerId], references: [id])

  listingId    String   @unique
  listing      Listing  @relation(fields: [listingId], references: [id])

  amountCents  Int
  feeCents     Int
  shipCents    Int
  shipMethod   String   @default("relais")
  status       OrderStatus @default(PAYMENT_INTENT)
  paymentPI    String?
  tracking     String?
  carrier      String?
  createdAt    DateTime @default(now())
}

model Review {
  id        String   @id @default(cuid())
  orderId   String   @unique
  aboutId   String
  authorId  String
  rating    Int
  comment   String?
  photoUrl  String?
  createdAt DateTime @default(now())

  about   User @relation("AboutReviews", fields: [aboutId], references: [id])
  author  User @relation("WrittenReviews", fields: [authorId], references: [id])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  authorId       String
  body           String
  createdAt      DateTime @default(now())

  @@index([conversationId, createdAt])
}

enum Role { USER MOD ADMIN }
enum Condition { NEW LIKE_NEW VERY_GOOD GOOD FAIR }
enum ListingStatus { ACTIVE RESERVED SOLD HIDDEN }
enum OfferStatus { PENDING ACCEPTED DECLINED EXPIRED }
enum OrderStatus { PAYMENT_INTENT PAID LABELED SHIPPED DELIVERED RELEASED REFUNDED CANCELED }